document.addEventListener("DOMContentLoaded",()=>{let e=document.body.getAttribute("data-csrf-token"),t=document.getElementById("audio"),n=document.getElementById("playBtn"),a=document.getElementById("prevBtn"),r=document.getElementById("nextBtn"),i=document.getElementById("shuffleBtn"),l=document.getElementById("repeatBtn"),s=document.getElementById("volume"),o=document.getElementById("current-time"),d=document.getElementById("duration"),c=document.getElementById("visualizer"),u=document.getElementById("progress-bar"),g=document.getElementById("status");document.getElementById("bitrate");let p=document.getElementById("current-year"),f=document.getElementById("current-song"),m=document.getElementById("current-artist"),y=document.getElementById("coverArt"),$=document.getElementById("playlist"),v=document.getElementById("refreshBtn"),x=document.getElementById("uploadBtn"),h=document.getElementById("uploadModal"),E=document.getElementById("cancelBtn"),L=document.getElementById("cancelUploadBtn"),b=document.getElementById("uploadForm"),w=document.getElementById("coverInput"),B=document.getElementById("coverFileName"),I=document.getElementById("coverPreview"),_=document.getElementById("coverPreviewImg"),C=document.getElementById("songInput"),S=document.getElementById("songFileName"),T=document.getElementById("toast"),k=document.getElementById("miniPlayer"),H=[],M=-1,A=!1,P=!1,N=!1,O=[],j,R,F;p.textContent=new Date().getFullYear();for(let U=0;U<50;U++){let q=document.createElement("div");q.className="bar",q.style.height="10px",c.appendChild(q)}let D=document.querySelectorAll(".bar");function J(e){return[Math.floor(e/3600).toString().padStart(2,"0"),Math.floor(e%3600/60).toString().padStart(2,"0"),Math.floor(e%60).toString().padStart(2,"0")].join(":")}function z(){if(o.textContent=J(t.currentTime),t.duration){d.textContent=J(t.duration);let e=t.currentTime/t.duration*100;u.style.width=`${e}%`}}function K(){try{(R=(j=new(window.AudioContext||window.webkitAudioContext)).createAnalyser()).fftSize=256;let e=j.createMediaElementSource(t);e.connect(R),R.connect(j.destination),F=new Uint8Array(R.frequencyBinCount),g.textContent="Playing",V()}catch(n){console.error("AudioContext setup error:",n),g.textContent="Error initializing audio playback: "+n.message,en("Audio system error. Please refresh.",!0)}}function V(){if(!R)return;R.getByteFrequencyData(F);let e=Math.floor(F.length/50);for(let t=0;t<50;t++){let n=0;for(let a=0;a<e;a++)n+=F[t*e+a];let r=n/e;D[t].style.height=`${r/2}px`}requestAnimationFrame(V)}async function X(){$.innerHTML=`
      <li class="text-center py-10">
        <div class="spinner mx-auto mb-2"></div>
        <p>Loading playlist...</p>
      </li>
    `;try{let e=await fetch("/?action=getPlaylist");if(!e.ok){let t=await e.text();throw Error(`Network response was not ok: ${e.status} ${e.statusText} - ${t}`)}let n=e.headers.get("content-type");if(!n||!n.includes("application/json")){let a=await e.text();throw console.error("Received non-JSON response:",a),TypeError("Oops, we haven't got JSON! Response: "+a.substring(0,100)+"...")}let r=await e.json();"success"===r.status&&r.data&&Array.isArray(r.data.songs)?(O=[...H=r.data.songs],Y(),en("Playlist loaded successfully!")):"error"===r.status&&r.message?(console.error("API error fetching playlist:",r.message),$.innerHTML=`<li class="text-center py-10 text-red-400"><i class="fas fa-exclamation-triangle text-3xl mb-2"></i><p>Error loading playlist: ${r.message}</p></li>`,en(`Error: ${r.message}`,!0)):(console.error("Invalid or unexpected JSON structure from getPlaylist:",r),$.innerHTML='<li class="text-center py-10 text-red-400"><i class="fas fa-exclamation-triangle text-3xl mb-2"></i><p>Failed to load playlist. Unexpected server response.</p></li>',en("Failed to load playlist: Unexpected response",!0))}catch(i){console.error("Critical error fetching playlist:",i),$.innerHTML='<li class="text-center py-10 text-red-400"><i class="fas fa-exclamation-triangle text-3xl mb-2"></i><p>Error loading playlist. Please check connection and try again.</p></li>',en("Network error or critical issue loading playlist.",!0)}}function Y(){if(0===H.length){$.innerHTML=`
        <li class="text-center py-10 text-white/50">
          <i class="fas fa-music text-3xl mb-2"></i>
          <p>No songs in playlist</p>
        </li>
      `;return}$.innerHTML=H.map((e,t)=>`
      <li class="song-item bg-white/5 p-3 rounded-lg cursor-pointer hover:bg-white/10 transition-all ${M===t?"current-song":""}"
           onclick="playSong(${t})">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-md overflow-hidden ${e.cover?"":"default-cover"}" ${e.cover?"":'aria-label="Default cover art icon"'}>
            ${e.cover?`<img src="/${e.cover}" class="w-full h-full object-cover" alt="Cover art for ${e.title||"song"}">`:'<i class="fas fa-music w-full h-full flex items-center justify-center" aria-hidden="true"></i>'}
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium truncate">${e.title}</p>
            <p class="text-sm text-white/70 truncate">${e.artist}</p>
          </div>
          <span class="text-xs text-white/50">${J(e.duration||0)}</span>
        </div>
      </li>
    `).join("")}function G(){if(P=!P){0===O.length&&(O=[...H]);for(let e=H.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1));[H[e],H[t]]=[H[t],H[e]]}if(-1!==M){let n=O[M],a=H.findIndex(e=>e.id===n.id);-1!==a&&(M=a)}i.classList.add("control-active"),en("Shuffle mode on")}else{let r=-1!==M&&M<H.length?H[M]:null;if(H=[...O],r){let l=H.findIndex(e=>e.id===r.id);-1!==l&&(M=l)}i.classList.remove("control-active"),en("Shuffle mode off")}Y()}function Q(){N=!N,l.classList.toggle("control-active",N),en(`Repeat mode ${N?"on":"off"}`)}async function W(e){if(e<0||e>=H.length)return;M=e;let a=H[e];f.textContent=a.title,m.textContent=a.artist,a.title.length>20?f.innerHTML=`<span class="marquee">${a.title}</span>`:f.textContent=a.title,a.cover?(y.innerHTML=`<img src="/${a.cover}" class="w-full h-full object-cover" alt="Cover art for ${a.title}">`,y.removeAttribute("aria-label")):(y.innerHTML='<i class="fas fa-music text-xl text-purple-400" aria-hidden="true"></i>',y.setAttribute("aria-label","Default cover art icon")),t.src=`/${a.file}`,t.load();try{await t.play(),n.innerHTML='<i class="fas fa-pause text-xl"></i>',n.classList.remove("bg-green-600","hover:bg-green-700"),n.classList.add("bg-blue-600","hover:bg-blue-700"),A=!0,g.textContent="Playing",k.innerHTML='<i class="fas fa-pause"></i>',k.classList.remove("hidden"),j||K(),en(`Now playing: ${a.title}`),ea(a)}catch(r){console.error("Error playing song:",a.title,r),en(`Error playing ${a.title}: ${r.message}`,!0),g.textContent="Error playing song"}}async function Z(){if(0===H.length){en("No songs in playlist",!0);return}if(-1===M){await W(0);return}if(t.paused)try{await t.play(),n.innerHTML='<i class="fas fa-pause text-xl"></i>',n.classList.remove("bg-green-600","hover:bg-green-700"),n.classList.add("bg-blue-600","hover:bg-blue-700"),A=!0,g.textContent="Playing",k.innerHTML='<i class="fas fa-pause"></i>',j||K()}catch(e){console.error("Play error:",e),en("Click anywhere to play",!0)}else t.pause(),n.innerHTML='<i class="fas fa-play text-xl"></i>',n.classList.remove("bg-blue-600","hover:bg-blue-700"),n.classList.add("bg-green-600","hover:bg-green-700"),A=!1,g.textContent="Paused",k.innerHTML='<i class="fas fa-play"></i>'}function ee(){if(0===H.length)return;let e=M-1;e<0&&(e=H.length-1),W(e)}function et(){if(0===H.length)return;if(N){t.currentTime=0,t.play().catch(e=>{console.error("Error re-playing song:",e),en(`Error playing: ${e.message}`,!0)});return}let e=M+1;e>=H.length&&(e=0),W(e)}function en(e,t=!1){T.textContent=e,T.className="fixed bottom-16 left-1/2 transform -translate-x-1/2 p-4 rounded-lg text-white z-50 transition-all duration-300 ease-in-out",t?T.classList.add("bg-red-500"):T.classList.add("bg-green-500"),T.classList.add("show"),clearTimeout(T.timeoutId),T.timeoutId=setTimeout(()=>{T.classList.remove("show"),T.className="fixed bottom-16 left-1/2 transform -translate-x-1/2 p-4 rounded-lg text-white z-50 transition-all duration-300 ease-in-out"},3e3)}function ea(e){"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:e.title,artist:e.artist,album:"Local Radio",artwork:e.cover?[{src:`/${e.cover}`}]:[]}),navigator.mediaSession.setActionHandler("play",Z),navigator.mediaSession.setActionHandler("pause",Z),navigator.mediaSession.setActionHandler("previoustrack",ee),navigator.mediaSession.setActionHandler("nexttrack",et))}n.addEventListener("click",Z),a.addEventListener("click",ee),r.addEventListener("click",et),i.addEventListener("click",G),l.addEventListener("click",Q),s.addEventListener("input",()=>{t.volume=s.value}),u.parentElement.addEventListener("click",e=>{if(!t.duration)return;let n=u.parentElement.getBoundingClientRect(),a=(e.clientX-n.left)/n.width;t.currentTime=a*t.duration}),t.addEventListener("loadedmetadata",z),t.addEventListener("timeupdate",z),t.addEventListener("ended",()=>{N?(t.currentTime=0,t.play().catch(e=>{console.error("Error re-playing song on end:",e),en(`Error playing: ${e.message}`,!0)})):et()}),t.addEventListener("error",e=>{console.error("Audio Error:",e),g.textContent="Error loading audio",en("Error loading audio file. It might be corrupt or unsupported.",!0)}),v.addEventListener("click",async()=>{v.innerHTML='<i class="fas fa-sync-alt animate-spin"></i>',await X(),v.innerHTML='<i class="fas fa-sync-alt"></i>'}),x.addEventListener("click",()=>{h&&(h.style.display="flex")}),E.addEventListener("click",()=>{h&&(h.style.display="none")}),L.addEventListener("click",()=>{h&&(h.style.display="none")}),w.addEventListener("change",e=>{let t=e.target.files[0];if(!t)return;B.textContent=t.name,I.classList.remove("hidden");let n=new FileReader;n.onload=e=>{_.src=e.target.result},n.readAsDataURL(t)}),C.addEventListener("change",e=>{let t=e.target.files[0];t&&(S.textContent=t.name)}),b.addEventListener("submit",async t=>{t.preventDefault();let n=t.target.querySelector('button[type="submit"]'),a=n.innerHTML;n.innerHTML='<div class="spinner mr-2"></div> Uploading...',n.disabled=!0;let r=new FormData(t.target);if(e)r.append("csrf_token",e);else{console.error("CSRF_TOKEN is not available from body data attribute."),en("A required security token is missing. Please refresh the page and ensure JavaScript can access it.",!0),n.innerHTML=a,n.disabled=!1;return}try{let i=await fetch("/?action=uploadSong",{method:"POST",body:r}),l=i.headers.get("content-type");if(!l||!l.includes("application/json")){let s=await i.text();throw console.error("Received non-JSON response from upload:",s),TypeError("Oops, we haven't got JSON from upload! Response: "+s.substring(0,100)+"...")}let o=await i.json();"success"===o.status?(await X(),h&&(h.style.display="none"),b.reset(),I.classList.add("hidden"),_.src="",B.textContent="Choose cover image",S.textContent="Choose MP3 file",en(o.message||"Song uploaded successfully!")):en(o.message||"Upload failed. Please try again.",!0)}catch(d){console.error("Upload error:",d),en("Upload failed: Network error or server issue. "+d.message,!0)}finally{n.innerHTML=a,n.disabled=!1}}),k.addEventListener("click",()=>{let e=document.querySelector(".w-full.max-w-2xl.bg-gray-800");e&&e.scrollIntoView({behavior:"smooth"})}),X(),window.playSong=W});
